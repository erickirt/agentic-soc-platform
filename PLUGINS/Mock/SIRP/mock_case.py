from PLUGINS.Mock.SIRP.mock_alert import alert_user_reported_phishing, alert_malware_blocked, alert_psexec_lateral, alert_credential_dumping, \
    alert_dns_tunnel_volume, alert_dns_long_query, alert_brute_force_ssh, alert_malware_execution, alert_unauthorized_access, alert_data_exfiltration, \
    alert_malicious_email_attachment, alert_privilege_escalation, alert_cloud_config_change, alert_brute_force_siem, alert_sql_injection_siem, \
    alert_ransomware_siem
from PLUGINS.Mock.SIRP.mock_api import now, past_5m, past_30m, past_1h, past_2h, past_7d, past_1d_18h, past_2d_6h, past_3d_12h, past_4d_20h, \
    past_5d_8h, past_6d_15h
from PLUGINS.Mock.SIRP.mock_enrichment import enrichment_business, enrichment_greynoise_scanner, \
    enrichment_urlhaus_malware, enrichment_geoip_russia, \
    enrichment_carbonblack_execution
from PLUGINS.Mock.SIRP.mock_ticket import ticket_jira, ticket_servicenow, ticket_pagerduty
from PLUGINS.SIRP.sirpapi import Case
from PLUGINS.SIRP.sirpmodel import (
    CaseModel, Severity, ImpactLevel, Confidence, ProductCategory, CaseStatus,
    CasePriority, CaseVerdict
)

# === Case 1: Phishing Email Attack (100% Coverage) ===
case1_phishing = CaseModel(
    title="Phishing Campaign Detected - 'Urgent Payroll Update'",
    severity=Severity.HIGH,
    impact=ImpactLevel.MEDIUM,
    priority=CasePriority.HIGH,
    src_url="https://sirp.example.com/cases/1",
    confidence=Confidence.HIGH,
    description="A targeted phishing campaign was identified. The email lured users to a fake login page to harvest credentials and deployed malware via an attachment.",
    category=ProductCategory.EMAIL,
    tags=["phishing", "credential-harvesting", "malware-delivery", "FIN-department"],
    status=CaseStatus.IN_PROGRESS,
    acknowledged_time=now,
    comment="L1 Analyst: Confirmed phishing. Escalating to L2 for impact analysis and remediation tracking.",
    closed_time=None,
    verdict=None,
    summary="",
    correlation_uid="CORR-PHISH-XYZ-123",
    workbook="### Phishing Investigation PlaybookLoader\n1. Analyze headers (`done`)\n2. Detonate URL/Attachment (`done`)\n3. Identify recipients (`in-progress`)\n4. Purge emails from mailboxes\n5. Reset compromised user passwords\n",
    analysis_rationale_ai="The email originates from an external, un-reputable domain and uses urgent language, a common phishing tactic. The URL leads to a non-standard login page with a self-signed certificate. The attachment hash matches known malware.",
    recommended_actions_ai="- Block sender domain 'evil-domain.com'\n- Reset passwords for all users who clicked the link\n- Scan all endpoints for the malware hash 'a1b2c3d4e5f6...'",
    attack_stage_ai="Initial Access, Execution",
    severity_ai=Severity.HIGH,
    confidence_ai=Confidence.HIGH,
    threat_hunting_report_ai="Threat hunting query initiated to find other emails from the same sender IP or with similar subject lines across the organization.",
    tickets=[ticket_jira],
    enrichments=[enrichment_business],
    alerts=[alert_user_reported_phishing, alert_malware_blocked]
)

# === Case 2: Endpoint Lateral Movement (100% Coverage) ===
case2_lateral_movement = CaseModel(
    title="Lateral Movement Detected via PsExec from DC01 to WS-FINANCE-05",
    severity=Severity.CRITICAL,
    impact=ImpactLevel.HIGH,
    priority=CasePriority.CRITICAL,
    confidence=Confidence.HIGH,
    description="An attacker, having compromised the Domain Controller 'DC01', is attempting to move laterally to a high-value workstation 'WS-FINANCE-05' in the Finance department using PsExec.",
    category=ProductCategory.EDR,
    tags=["lateral-movement", "psexec", "golden-ticket", "domain-compromise"],
    status=CaseStatus.RESOLVED,
    acknowledged_time=past_5m,
    comment="Incident Response Complete. IOCs have been added to blocklists. Awaiting final report.",
    closed_time=now,
    verdict=CaseVerdict.TRUE_POSITIVE,
    summary="Attacker compromised DC01 and moved to WS-FINANCE-05. Both hosts have been isolated and are pending reimaging. All domain admin credentials have been rotated.",
    correlation_uid="CORR-LAT-MOV-456",
    workbook="### Lateral Movement PlaybookLoader\n1. Isolate source and destination (`done`)\n2. Dump memory from hosts (`done`)\n3. Analyze for persistence (`done`)\n4. Rotate credentials (`done`)",
    analysis_rationale_ai="PsExec execution from a domain controller to a workstation is highly anomalous. The initial compromise vector on DC01 appears to be related to a credential dumping alert moments before the lateral movement.",
    recommended_actions_ai="- Isolate both DC01 and WS-FINANCE-05 immediately.\n- Investigate DC01 for initial compromise.\n- Rotate all privileged credentials.",
    attack_stage_ai="Lateral Movement",
    severity_ai=Severity.CRITICAL,
    confidence_ai=Confidence.HIGH,
    threat_hunting_report_ai="",
    tickets=[ticket_servicenow],
    alerts=[alert_psexec_lateral, alert_credential_dumping]
)

# === Case 3: DNS Tunneling C2 (100% Coverage) ===
case3_dns_tunnel = CaseModel(
    title="Suspected DNS Tunneling for C2 Communication from WS-MARKETING-12",
    severity=Severity.MEDIUM,
    impact=ImpactLevel.LOW,
    priority=CasePriority.MEDIUM,
    confidence=Confidence.HIGH,
    description="An endpoint 'WS-MARKETING-12' is exhibiting DNS query patterns indicative of DNS tunneling, likely for command-and-control (C2) communication. This is a low-and-slow exfiltration or C2 method.",
    category=ProductCategory.NDR,
    tags=["dns-tunneling", "c2", "ndr", "exfiltration"],
    status=CaseStatus.ON_HOLD,
    acknowledged_time=now,
    comment="Awaiting more data. Placed host in a monitoring group. No immediate action taken to avoid tipping off the attacker.",
    closed_time=None,
    verdict=CaseVerdict.SUSPICIOUS,
    summary="",
    correlation_uid="CORR-DNS-TUN-789",
    workbook="### DNS Tunneling PlaybookLoader\n1. Analyze query patterns (TXT/NULL record types, query length)\n2. Check domain reputation\n3. Perform packet capture on host\n4. Compare against baseline DNS traffic",
    analysis_rationale_ai="The high volume of TXT queries to a single, non-business related domain is a strong indicator of DNS tunneling. The query payloads appear to be encoded.",
    recommended_actions_ai="- Place the host in a sinkhole network to observe C2 traffic safely.\n- Do not block immediately to gather more intelligence on the attacker's infrastructure.",
    attack_stage_ai="Command and Control",
    severity_ai=Severity.MEDIUM,
    confidence_ai=Confidence.MEDIUM,
    threat_hunting_report_ai="",
    tickets=[],
    enrichments=[],
    alerts=[alert_dns_tunnel_volume, alert_dns_long_query]
)

# === Case 4: SSH Brute Force Attack ===
case4_brute_force = CaseModel(
    title="SSH Brute Force Attack on SQL Server Database",
    severity=Severity.HIGH,
    impact=ImpactLevel.MEDIUM,
    priority=CasePriority.HIGH,
    confidence=Confidence.HIGH,
    description="An external attacker is performing a coordinated SSH brute force attack against the production SQL database server. Multiple failed login attempts detected from a known malicious IP.",
    category=ProductCategory.OT,
    tags=["brute-force", "ssh", "database", "credential-access"],
    status=CaseStatus.IN_PROGRESS,
    acknowledged_time=past_1d_18h,
    comment="Attack blocked by firewall rules. Monitoring enabled. User credentials reset as precaution.",
    closed_time=None,
    verdict=None,
    summary="",
    correlation_uid="CORR-BRUTE-001",
    workbook="### Brute Force Investigation\n1. Verify firewall blocks are in place (`done`)\n2. Review successful logins from source IP (`in-progress`)\n3. Reset database credentials (`done`)\n4. Monitor for further attempts",
    analysis_rationale_ai="245 failed login attempts in 15 minutes is indicative of automated password guessing attack.",
    recommended_actions_ai="- Keep firewall block in place\n- Review SSH access logs for successful authentications from this IP\n- Enforce MFA on database access",
    attack_stage_ai="Credential Access",
    severity_ai=Severity.HIGH,
    confidence_ai=Confidence.HIGH,
    threat_hunting_report_ai="",
    tickets=[ticket_jira],
    alerts=[alert_brute_force_ssh]
)

# === Case 5: Ransomware Detection and Response ===
case5_ransomware = CaseModel(
    title="Ransomware Execution Detected - Immediate Containment",
    severity=Severity.CRITICAL,
    impact=ImpactLevel.HIGH,
    priority=CasePriority.CRITICAL,
    confidence=Confidence.HIGH,
    description="A ransomware malware has been executed on a workstation. File encryption behaviors detected. Immediate isolation and containment actions initiated.",
    category=ProductCategory.EDR,
    tags=["ransomware", "malware", "encryption", "incident-response"],
    status=CaseStatus.IN_PROGRESS,
    acknowledged_time=past_2d_6h,
    comment="Endpoint isolated from network. Forensic imaging in progress. Backup restore plan initiated.",
    closed_time=None,
    verdict=None,
    summary="",
    correlation_uid="CORR-RANSOMWARE-001",
    workbook="### Ransomware Response Playbook\n1. Isolate endpoint (`done`)\n2. Dump memory for forensic analysis (`in-progress`)\n3. Scan for lateral movement (`in-progress`)\n4. Prepare backup restore\n5. Notify executive team",
    analysis_rationale_ai="PowerShell execution with file encryption and network scanning behavior is characteristic of modern ransomware families.",
    recommended_actions_ai="- Restore from clean backup once investigation completes\n- Segment network to prevent spread\n- Hunt for similar behavior on other endpoints",
    attack_stage_ai="Impact",
    severity_ai=Severity.CRITICAL,
    confidence_ai=Confidence.HIGH,
    threat_hunting_report_ai="",
    tickets=[ticket_pagerduty],
    alerts=[alert_malware_execution]
)

# === Case 6: Unauthorized Access and Data Theft ===
case6_unauthorized_access = CaseModel(
    title="Unauthorized Access to Confidential Data - Insider Threat Investigation",
    severity=Severity.MEDIUM,
    impact=ImpactLevel.MEDIUM,
    priority=CasePriority.MEDIUM,
    confidence=Confidence.MEDIUM,
    description="User 'sarah.johnson' from Sales department accessed restricted executive confidential files outside of business hours. Potential insider threat or compromised account.",
    category=ProductCategory.IAM,
    tags=["insider-threat", "unauthorized-access", "data-theft", "user-behavior"],
    status=CaseStatus.IN_PROGRESS,
    acknowledged_time=past_3d_12h,
    comment="User management notified. Account under enhanced monitoring. Behavioral analysis in progress.",
    closed_time=None,
    verdict=None,
    summary="",
    correlation_uid="CORR-UNAUTH-002",
    workbook="### Insider Threat Investigation\n1. Interview user about access (`pending`)\n2. Review all file access logs (`in-progress`)\n3. Check for data exfiltration (`in-progress`)\n4. Determine if account is compromised (`pending`)",
    analysis_rationale_ai="Off-hours access to restricted files is anomalous for this user's role and may indicate account compromise or malicious intent.",
    recommended_actions_ai="- Conduct forensic interview with user\n- Check user's email for suspicious activity\n- Review all connected devices for malware",
    attack_stage_ai="Lateral Movement",
    severity_ai=Severity.MEDIUM,
    confidence_ai=Confidence.MEDIUM,
    threat_hunting_report_ai="",
    tickets=[],
    alerts=[alert_unauthorized_access]
)

# === Case 7: Data Exfiltration via C2 ===
case7_data_exfil = CaseModel(
    title="Suspected Data Exfiltration via C2 Channel",
    severity=Severity.CRITICAL,
    impact=ImpactLevel.CRITICAL,
    priority=CasePriority.CRITICAL,
    confidence=Confidence.HIGH,
    description="A server is transferring large volumes of sensitive data to an external suspicious domain. Pattern matches known C2 exfiltration techniques.",
    category=ProductCategory.DLP,
    tags=["data-exfiltration", "c2", "advanced-threat", "incident-response"],
    status=CaseStatus.IN_PROGRESS,
    acknowledged_time=past_4d_20h,
    comment="Server isolated. Network traffic capture in progress. Law enforcement notified.",
    closed_time=None,
    verdict=None,
    summary="",
    correlation_uid="CORR-EXFIL-003",
    workbook="### Data Exfiltration Response\n1. Isolate server (`done`)\n2. Block destination domain (`done`)\n3. Capture network traffic (`in-progress`)\n4. Identify data scope (`in-progress`)\n5. Notify affected customers (`pending`)",
    analysis_rationale_ai="2.3 GB of data transfer to unknown domain in 45 minutes suggests automated exfiltration process, likely malware-driven.",
    recommended_actions_ai="- Conduct forensic analysis of server\n- Determine data exfiltrated and notify customers\n- Hunt for similar C2 connections\n- Implement egress filtering",
    attack_stage_ai="Exfiltration",
    severity_ai=Severity.CRITICAL,
    confidence_ai=Confidence.HIGH,
    threat_hunting_report_ai="",
    tickets=[ticket_servicenow],
    alerts=[alert_data_exfiltration]
)

# === Case 8: Email-based Attack Campaign ===
case8_email_campaign = CaseModel(
    title="Malicious Email Campaign with Office Macro Malware",
    severity=Severity.HIGH,
    impact=ImpactLevel.MEDIUM,
    priority=CasePriority.HIGH,
    confidence=Confidence.HIGH,
    description="A coordinated email campaign distributing documents with malicious macros. Multiple recipients targeted. Gateway quarantine prevented infections.",
    category=ProductCategory.EMAIL,
    tags=["phishing", "malware", "macro", "email-campaign"],
    status=CaseStatus.RESOLVED,
    acknowledged_time=past_5d_8h,
    comment="All emails quarantined. Sender domain blacklisted. User training scheduled.",
    closed_time=now,
    verdict=CaseVerdict.TRUE_POSITIVE,
    summary="Email campaign was successfully detected and quarantined before any endpoints were compromised.",
    correlation_uid="CORR-MACRO-004",
    workbook="### Email Security Response\n1. Identify all affected recipients (`done`)\n2. Quarantine malicious emails (`done`)\n3. Block sender domain (`done`)\n4. Schedule user security training (`done`)",
    analysis_rationale_ai="VBA macro attempting PowerShell execution is a classic attack vector for delivering secondary malware payloads.",
    recommended_actions_ai="- Deploy macro blocking policies\n- Educate users about macro dangers\n- Implement YARA rules to detect similar patterns",
    attack_stage_ai="Initial Access, Execution",
    severity_ai=Severity.HIGH,
    confidence_ai=Confidence.HIGH,
    threat_hunting_report_ai="",
    tickets=[ticket_jira],
    alerts=[alert_malicious_email_attachment]
)

# === Case 9: Privilege Escalation Attack ===
case9_priv_esc = CaseModel(
    title="Privilege Escalation Attack via UAC Bypass",
    severity=Severity.CRITICAL,
    impact=ImpactLevel.HIGH,
    priority=CasePriority.CRITICAL,
    confidence=Confidence.HIGH,
    description="An attacker exploited a known UAC bypass vulnerability to escalate from user context to SYSTEM privileges. Potential for full system compromise.",
    category=ProductCategory.EDR,
    tags=["privilege-escalation", "windows", "exploit", "uac-bypass"],
    status=CaseStatus.IN_PROGRESS,
    acknowledged_time=past_6d_15h,
    comment="Endpoint isolated. Vulnerability patching in progress. Post-exploitation analysis ongoing.",
    closed_time=None,
    verdict=None,
    summary="",
    correlation_uid="CORR-PE-005",
    workbook="### Privilege Escalation Response\n1. Isolate endpoint (`done`)\n2. Analyze post-exploitation behavior (`in-progress`)\n3. Search for persistence mechanisms (`in-progress`)\n4. Patch Windows (`in-progress`)",
    analysis_rationale_ai="UAC bypass technique CVE-2019-1315 via CMSTP executable indicates sophisticated attacker with knowledge of Windows security mechanisms.",
    recommended_actions_ai="- Apply Windows security patches\n- Check for persistence (scheduled tasks, registry modifications)\n- Reset local administrator passwords",
    attack_stage_ai="Privilege Escalation",
    severity_ai=Severity.CRITICAL,
    confidence_ai=Confidence.HIGH,
    threat_hunting_report_ai="",
    tickets=[ticket_pagerduty],
    alerts=[alert_privilege_escalation]
)

# === Case 10: Cloud Security Misconfiguration ===
case10_cloud_misconfig = CaseModel(
    title="S3 Bucket Exposed to Internet - Customer Data at Risk",
    severity=Severity.CRITICAL,
    impact=ImpactLevel.CRITICAL,
    priority=CasePriority.CRITICAL,
    confidence=Confidence.HIGH,
    description="A production AWS S3 bucket containing customer PII was exposed to public read access. Potentially millions of records affected.",
    category=ProductCategory.CLOUD,
    tags=["cloud-security", "aws", "data-exposure", "compliance"],
    status=CaseStatus.IN_PROGRESS,
    acknowledged_time=past_7d,
    comment="Bucket policy reverted. Data breach notification team activated. Forensic analysis of modification initiated.",
    closed_time=None,
    verdict=None,
    summary="",
    correlation_uid="CORR-CLOUD-006",
    workbook="### Cloud Security Response\n1. Revert policy to private (`done`)\n2. Enable MFA delete (`done`)\n3. Audit bucket access logs (`in-progress`)\n4. Check for data downloads (`in-progress`)\n5. Notify legal/compliance (`in-progress`)",
    analysis_rationale_ai="S3 bucket policy change to allow public read access suggests either misconfiguration or unauthorized modification by attacker.",
    recommended_actions_ai="- Implement SCPs to prevent public S3 policies\n- Enable CloudTrail monitoring\n- Conduct data breach investigation\n- Notify affected customers per GDPR/CCPA",
    attack_stage_ai="Exfiltration",
    severity_ai=Severity.CRITICAL,
    confidence_ai=Confidence.HIGH,
    threat_hunting_report_ai="",
    tickets=[ticket_servicenow],
    alerts=[alert_cloud_config_change]
)

# === Case 11: Brute Force SSH Attack (From SIEM Scenario) ===
case11_brute_force = CaseModel(
    title="Brute Force Attack: Multiple Failed Login Attempts Followed by Successful Compromise",
    severity=Severity.CRITICAL,
    impact=ImpactLevel.HIGH,
    priority=CasePriority.CRITICAL,
    confidence=Confidence.HIGH,
    description="External attacker from China (IP: 45.95.11.22) conducted a brute force attack against production web server admin account. After 7 failed attempts, attacker successfully compromised the admin account.",
    category=ProductCategory.SIEM,
    tags=["brute-force", "ssh", "credential-attack", "account-compromise", "china", "high-risk"],
    status=CaseStatus.IN_PROGRESS,
    acknowledged_time=past_1h,
    comment="L2 Analyst: Admin account is confirmed compromised. Immediate password reset, session termination, and command audit in progress. Source IP blocked at firewall.",
    closed_time=None,
    verdict=None,
    summary="",
    correlation_uid="CORR-BRUTE-FORCE-001",
    workbook="### Brute Force Attack Response\n1. Confirm account compromise (`done`)\n2. Reset admin password (`done`)\n3. Terminate all admin sessions (`done`)\n4. Review command history (`in-progress`)\n5. Check for lateral movement (`in-progress`)\n6. Block source IP globally (`done`)\n7. Enable MFA for admin (`pending`)",
    analysis_rationale_ai="Attack pattern clearly indicates brute force: consistent failed auth attempts from single IP followed by immediate success. Source IP reputation is MALICIOUS. Geographic origin (China) is high-risk for admin account.",
    recommended_actions_ai="- IMMEDIATE: Force password reset for admin account. 2. Review all commands executed by admin since last_seen_time. 3. Block source IP 45.95.11.22 at firewall. 4. Enable MFA for admin account. 5. Review login history for other successful attempts from this IP.",
    attack_stage_ai="Credential Access",
    severity_ai=Severity.CRITICAL,
    confidence_ai=Confidence.HIGH,
    threat_hunting_report_ai="Query: Show all failed login attempts from external IPs in last 7 days | Show all successful logins from 45.95.11.22 in last 7 days | Check for similar brute force patterns from other IP ranges",
    tickets=[ticket_pagerduty],
    enrichments=[enrichment_greynoise_scanner, enrichment_geoip_russia],
    alerts=[alert_brute_force_siem]
)

# === Case 12: SQL Injection Web Attack (From SIEM Scenario) ===
case12_sql_injection = CaseModel(
    title="SQL Injection Attack: Automated Scanner Detected and Blocked by WAF",
    severity=Severity.HIGH,
    impact=ImpactLevel.MEDIUM,
    priority=CasePriority.HIGH,
    confidence=Confidence.HIGH,
    description="Web Application Firewall detected SQL injection attack from Russia using automated sqlmap tool. Attacker attempted multiple SQL injection vectors against the user API endpoint. All attacks were successfully blocked.",
    category=ProductCategory.WAF,
    tags=["sql-injection", "web-attack", "waf", "automated-scanner", "owasp-top-10"],
    status=CaseStatus.RESOLVED,
    acknowledged_time=past_30m,
    comment="L3 Security Engineer: Attack was fully contained by WAF rules. No database compromise detected. Recommended code review to identify and fix potential SQL injection vulnerabilities.",
    closed_time=now,
    verdict=CaseVerdict.TRUE_POSITIVE,
    summary="SQL injection attack was detected and blocked by WAF. No application or database compromise occurred. Attacker IP has been blocked and monitoring is ongoing.",
    correlation_uid="CORR-SQL-INJ-001",
    workbook="### SQL Injection Response\n1. Block attacker IP (`done`)\n2. Review WAF logs for patterns (`done`)\n3. Audit application code for injection vulnerabilities (`done`)\n4. Deploy parameterized query fixes (`pending`)\n5. Conduct SAST scan of codebase (`pending`)",
    analysis_rationale_ai="SQL injection attempt with multiple payloads (boolean blind, time-based, UNION-based) indicates automated tool usage (sqlmap). However, WAF successfully blocked all attempts. No evidence of database access or compromise.",
    recommended_actions_ai="- Update WAF rules with new detection patterns (COMPLETED)\n- Review application code for SQL injection vulnerabilities\n- Implement parameterized queries in API endpoint /api/user\n- Add request rate limiting\n- Conduct security code review of all database interactions\n- Plan penetration test after fixes are deployed",
    attack_stage_ai="Exploitation",
    severity_ai=Severity.HIGH,
    confidence_ai=Confidence.HIGH,
    threat_hunting_report_ai="",
    tickets=[ticket_jira],
    enrichments=[enrichment_urlhaus_malware],
    alerts=[alert_sql_injection_siem]
)

# === Case 13: Active Ransomware Encryption (From SIEM Scenario) ===
case13_ransomware = CaseModel(
    title="CRITICAL: Active Ransomware Execution on Production Database Server",
    severity=Severity.CRITICAL,
    impact=ImpactLevel.CRITICAL,
    priority=CasePriority.CRITICAL,
    confidence=Confidence.HIGH,
    description="CRITICAL INCIDENT: Ransomware malware detected executing on production database server 'srv-db-master' with three confirmed attack indicators: 1) Shadow Copy deletion via vssadmin.exe 2) Bulk file encryption (20+ files renamed to .encrypted) 3) Ransom note creation. Immediate response required.",
    category=ProductCategory.EDR,
    tags=["ransomware", "file-encryption", "critical-incident", "active-threat", "recovery-required"],
    status=CaseStatus.IN_PROGRESS,
    acknowledged_time=past_2h,
    comment="INCIDENT COMMANDER: All-hands-on-deck response initiated. Host isolated. Crisis management team assembled. Legal/Law Enforcement notifications pending. Do NOT negotiate with attacker. Do NOT shutdown infected system. Prepare for potential multi-day recovery.",
    closed_time=None,
    verdict=None,
    summary="",
    correlation_uid="CORR-RANSOMWARE-ACTIVE-001",
    workbook="### CRITICAL: Ransomware Response Playbook\n**IMMEDIATE ACTIONS (0-15 min):**\n- [x] Isolate infected host from network\n- [x] Preserve forensic evidence (disk/memory dumps initiated)\n- [x] Notify incident response team\n- [x] Activate disaster recovery plan\n\n**SHORT TERM (15 min - 2 hours):**\n- [x] Assess backup integrity\n- [ ] Identify attack vector (email, RDP, SMB, supply chain)\n- [ ] Hunt for lateral movement indicators\n- [ ] Review EDR logs for persistence mechanisms\n- [ ] Activate clean backup restoration\n\n**MEDIUM TERM (2-24 hours):**\n- [ ] Complete system restore from clean backup\n- [ ] Verify restored system integrity\n- [ ] Analyze forensic artifacts\n- [ ] Identify and patch vulnerability used for initial compromise\n- [ ] Review all privileged account activity\n\n**LONG TERM:**\n- [ ] Incident report and lessons learned\n- [ ] Security control improvements\n- [ ] Backup and recovery procedures review",
    analysis_rationale_ai="Three concurrent indicators confirm active ransomware: (1) vssadmin.exe shadow copy deletion removes backup recovery options, (2) Bulk file encryption of business-critical files with .encrypted extension, (3) Ransom note creation indicates attacker demand. This is NOT a false positive. This is a confirmed active attack requiring full incident response activation.",
    recommended_actions_ai="CRITICAL ACTIONS - EXECUTE IMMEDIATELY:\n1. ✓ NETWORK ISOLATION: Disconnect infected host from all networks (COMPLETED)\n2. ✓ PRESERVE EVIDENCE: Initiate forensic disk/memory capture (COMPLETED)\n3. ✓ DO NOT SHUTDOWN: Risk unrecoverable data if malware not fully executed\n4. BACKUP ASSESSMENT: Verify clean backup exists before infection date\n5. RECOVERY ACTIVATION: Prepare clean backup for immediate restoration\n6. ATTACK VECTOR IDENTIFICATION: Determine compromise method (email, RDP, SMB, web shell)\n7. LATERAL MOVEMENT CHECK: Hunt for infection spread to other systems\n8. PERSISTENCE SEARCH: Look for scheduled tasks, registry modifications, services\n9. STAKEHOLDER NOTIFICATION: Inform affected business units, customers, regulators\n10. LAW ENFORCEMENT: Contact FBI/local authorities for APT attribution and coordination",
    attack_stage_ai="Impact / Ransomware Execution",
    severity_ai=Severity.CRITICAL,
    confidence_ai=Confidence.HIGH,
    threat_hunting_report_ai="URGENT HUNTS:\n- Find all processes executed by user 'dbadmin' in last 2 hours\n- Identify all processes accessing files with .encrypted extension\n- Check for vssadmin.exe execution on all hosts (indicates lateral movement)\n- Review all RDP/SMB connections to this host in last 24 hours\n- Search for similar encrypted file extensions across file shares\n- Check for ransom notes on network shares (indicates spread)\n- Monitor command/control traffic patterns from isolated host\n- Identify initial entry point: email attachment, RDP brute force, SMB exploit, web shell",
    tickets=[ticket_servicenow, ticket_pagerduty],
    enrichments=[enrichment_carbonblack_execution],
    alerts=[alert_ransomware_siem]
)

if __name__ == "__main__":
    import os
    import django

    os.environ.setdefault("DJANGO_SETTINGS_MODULE", "ASP.settings")
    django.setup()

    for case in [
        case1_phishing,
        case2_lateral_movement,
        case3_dns_tunnel,
        case4_brute_force,
        case5_ransomware,
        case6_unauthorized_access,
        case7_data_exfil,
        case8_email_campaign,
        case9_priv_esc,
        case10_cloud_misconfig,
        case11_brute_force,
        case12_sql_injection,
        case13_ransomware
    ]:
        Case.update_or_create(case)
